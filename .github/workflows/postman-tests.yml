name: Postman API Tests

# Run on push to main/develop, PRs, or manually
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'api/**'
      - 'Stock_AI_Platform_API.postman_collection.json'
      - '.github/workflows/postman-tests.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  newman-tests:
    name: Newman API Tests
    runs-on: ubuntu-latest

    services:
      # PostgreSQL database for testing
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: stock_ai_ai
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python for API server
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # 3. Install Python dependencies
      - name: Install Python dependencies
        run: |
          cd api
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # 4. Set up Node.js for Newman
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 5. Install Newman and reporters
      - name: Install Newman and reporters
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra
          newman --version

      # 6. Run database migrations
      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/stock_ai_ci
        run: |
          cd api
          alembic upgrade head 

      # 7. Create .env file for API
      - name: Create .env file
        run: |
          cat > api/.env << EOF
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/stock_ai_ci
          APP_NAME=Stock AI Platform
          APP_VERSION=1.0.0
          ENVIRONMENT=test
          DEBUG=false
          API_PORT=8000
          CORS_ORIGINS=["http://localhost:3000"]
          EOF

      # 8. Start API server
      - name: Start API server
        run: |
          cd api
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
          echo $! > server.pid

          # Wait for server to be healthy
          echo "Waiting for API server to start..."
          for i in {1..60}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "‚úÖ API server is ready!"
              curl http://localhost:8000/
              break
            fi
            if [ $i -eq 60 ]; then
              echo "‚ùå Server failed to start in 60 seconds"
              cat server.log
              exit 1
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done

      # 9. Run Newman tests
      - name: Run Newman collection
        id: newman
        run: |
          newman run Stock_AI_Platform_API.postman_collection.json \
            --environment <(echo '{"values":[{"key":"base_url","value":"http://localhost:8000","enabled":true}]}') \
            --reporters cli,htmlextra,json \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-htmlextra-title "Stock AI Platform API Tests - Run #${{ github.run_number }}" \
            --reporter-htmlextra-browserTitle "API Test Report" \
            --reporter-json-export reports/newman-report.json \
            --bail \
            --timeout-request 15000 \
            --delay-request 500 \
            --color on
        continue-on-error: true

      # 10. Display server logs if tests fail
      - name: Display server logs on failure
        if: failure()
        run: |
          echo "=== API Server Logs ==="
          cat api/server.log || echo "No server logs found"

      # 11. Upload test reports
      - name: Upload Newman HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-report-html
          path: reports/newman-report.html
          retention-days: 30

      - name: Upload Newman JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-report-json
          path: reports/newman-report.json
          retention-days: 30

      # 12. Parse and comment test results (for PRs)
      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('reports/newman-report.json', 'utf8'));
              const stats = report.run.stats;
              const failures = report.run.failures;

              const passed = stats.assertions.total - stats.assertions.failed;
              const passRate = ((passed / stats.assertions.total) * 100).toFixed(1);

              let comment = `## üß™ Postman API Test Results\n\n`;
              comment += `**Run**: #${{ github.run_number }}\n`;
              comment += `**Status**: ${stats.assertions.failed === 0 ? '‚úÖ PASSED' : '‚ùå FAILED'}\n\n`;
              comment += `### Statistics\n`;
              comment += `- **Requests**: ${stats.requests.total} (${stats.requests.failed} failed)\n`;
              comment += `- **Assertions**: ${stats.assertions.total} (${passed} passed, ${stats.assertions.failed} failed)\n`;
              comment += `- **Pass Rate**: ${passRate}%\n`;
              comment += `- **Duration**: ${(stats.requests.average / 1000).toFixed(2)}s avg\n\n`;

              if (failures && failures.length > 0) {
                comment += `### ‚ùå Failed Tests\n\n`;
                failures.slice(0, 5).forEach(failure => {
                  comment += `- **${failure.source.name}**: ${failure.error.message}\n`;
                });
                if (failures.length > 5) {
                  comment += `\n_... and ${failures.length - 5} more failures_\n`;
                }
              }

              comment += `\n[View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not parse Newman report:', error);
            }

      # 13. Stop API server
      - name: Stop API server
        if: always()
        run: |
          if [ -f api/server.pid ]; then
            kill $(cat api/server.pid) || true
            rm api/server.pid
          fi

      # 14. Fail workflow if tests failed
      - name: Check test results
        if: steps.newman.outcome == 'failure'
        run: |
          echo "‚ùå Newman tests failed"
          exit 1
